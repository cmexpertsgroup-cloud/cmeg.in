<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CM Tax Experts - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root { --primary-red: #B71C1C; --light-grey: #f5f5f5; --dark-grey: #333; }
        body { font-family: 'Roboto', sans-serif; background: var(--light-grey); margin: 0; padding: 20px; color: var(--dark-grey); }
        
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .logo-img { height: 60px; } 
        
        .upi-box { background: #FFEBEE; padding: 10px; border: 1px solid #ffcdd2; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .upi-dropdown { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; }
        
        .client-card { border-bottom: 1px solid #eee; padding: 15px 0; display: flex; justify-content: space-between; align-items: flex-start; }
        .client-info h3 { margin: 0; font-size: 16px; font-weight: 700; }
        
        .amount-badge { background: var(--primary-red); color: white; padding: 4px 8px; border-radius: 4px; font-size: 14px; font-weight: bold; margin-top: 5px; display: inline-block; }
        
        .btn-wa { background: #25D366; color: white; padding: 10px 15px; border-radius: 6px; text-decoration: none; font-size: 14px; display: flex; align-items: center; gap: 5px; font-weight: 500; cursor: pointer; border: none; }
        
        .btn-qr { background: #fff; color: #333; border: 1px solid #ccc; padding: 8px 15px; border-radius: 6px; cursor: pointer; margin-top: 8px; font-size: 12px; width: 100%; }
        .qr-box { display: none; margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; text-align: center; }
        
        .actions { display: flex; flex-direction: column; align-items: flex-end; }
        .phone-display { font-size: 11px; color: #999; margin-top: 2px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="logocmte.png" alt="CM Tax Experts" class="logo-img" onerror="this.style.display='none'">
        <h3>PAYMENT PORTAL ADMIN</h3>
        <button onclick="location.reload()" style="border:none; background:none; color:#666; cursor:pointer; font-size:14px;">
            <i class="fa-solid fa-rotate"></i> Refresh Data
        </button>
    </div>

    <div class="upi-box">
        <label style="font-size:12px; font-weight:bold; color:var(--primary-red);">SELECT ADMIN UPI:</label>
        <select id="adminUpiSelect" class="upi-dropdown" onchange="renderList()">
            <option value="cmtaxexperts@ybl">cmtaxexperts@ybl (Tax Related)</option>
            <option value="accountree1@fdl">accountree1@fdl (Accounting)</option>
        </select>
    </div>

    <div id="loading" style="text-align:center;">Loading Data...</div>
    <div id="clientList"></div>
</div>

<script>
    // === WEB APP URL ===
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyiBS9Xy9t3qvTKSipXRXLRJBmQJ9SeTEGZiyBh21eDRgiDobRvsVXGb1f7At6QuHv1/exec';
    
    let globalData = [];

    fetch(WEB_APP_URL + '?nocache=' + new Date().getTime())
        .then(res => res.json())
        .then(data => {
            document.getElementById('loading').style.display = 'none';
            globalData = data;
            renderList();
        })
        .catch(err => {
            document.getElementById('loading').innerHTML = 'Error loading data.';
        });

    function renderList() {
        const list = document.getElementById('clientList');
        const selectedUPI = document.getElementById('adminUpiSelect').value;
        list.innerHTML = '';

        if(globalData.length === 0) { list.innerHTML = '<div style="text-align:center;">No Pending Payments</div>'; return; }

        globalData.forEach(row => {
            // Force Numbers
            const total = Number(row.total || row.amount || 0);
            const gstRent = Number(row.gstRent || 0);
            const fee = Number(row.fee || 0);
            const gstEpf = Number(row.gstEpf || 0);

            // Phone Logic
            let rawPhone = row.phone ? row.phone.toString() : '';
            let cleanPhone = rawPhone.replace(/[^0-9]/g, '');
            let finalPhone = '';
            let isPhoneValid = false;

            if (cleanPhone.length >= 10) {
                finalPhone = '91' + cleanPhone.slice(-10);
                isPhoneValid = true;
            }

            // Payment Link
            const link = `https://cmeg.in/pay?client=${encodeURIComponent(row.client)}&amt=${total}&upi=${encodeURIComponent(selectedUPI)}`;

            // === SPECIFIC SERVICE DESCRIPTIONS ADDED HERE ===
            let breakdown = "";
            if (gstRent > 0) breakdown += `  • GST on Rent: Rs.${gstRent}\n`;
            if (fee > 0)     breakdown += `  • GST Return / Professional Fee: Rs.${fee}\n`;
            if (gstEpf > 0)  breakdown += `  • GST & EPF Payment: Rs.${gstEpf}\n`;

            // Message Construction
            let msg = `*PAYMENT DUE*\n\nHello *${row.client}*,\n\n`;

            if (breakdown !== "") {
                msg += `Your invoice amount for:\n${breakdown}\nis pending.\n\n`;
            } else {
                msg += `Your invoice payment is pending.\n\n`;
            }

            msg += `*Total Payable: Rs.${total}/-*\n\nPlease scan the QR code or pay securely using this link:\n${link}\n\nUPI id:\ncmtaxexperts@ybl (Tax Related)\naccountree1@fdl (Accounting & Auditing)`;
            
            // Send Button Logic
            let waLink;
            if (isPhoneValid) {
                waLink = `https://wa.me/${finalPhone}?text=${encodeURIComponent(msg)}`;
            } else {
                waLink = `https://wa.me/?text=${encodeURIComponent(msg)}`;
            }

            const btnText = isPhoneValid ? 'Send' : 'Select Contact';
            const phoneDisplayText = isPhoneValid ? finalPhone : 'No Number Saved';

            // QR
            const upiString = `upi://pay?pa=${selectedUPI}&pn=CMExperts&am=${total}&tn=Bill-${row.client}`;

            const div = document.createElement('div');
            div.className = 'client-card';
            div.innerHTML = `
                <div class="client-info">
                    <h3>${row.client}</h3>
                    <div class="amount-badge">₹ ${total}</div>
                    <div class="phone-display">${phoneDisplayText}</div>
                </div>
                <div class="actions">
                    <button onclick="window.open('${waLink}', '_blank')" class="btn-wa">
                        <i class="fa-brands fa-whatsapp"></i> ${btnText}
                    </button>
                    <button class="btn-qr" onclick="toggleQR(this, '${upiString}')">QR</button>
                    <div class="qr-box"></div>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function toggleQR(btn, data) {
        const box = btn.nextElementSibling;
        if (box.style.display === 'block') {
            box.style.display = 'none';
        } else {
            if (box.innerHTML === '') new QRCode(box, { text: data, width: 100, height: 100 });
            box.style.display = 'block';
        }
    }
</script>

</body>
</html>
