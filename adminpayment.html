<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CM Tax Experts - Admin Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            /* THEME: Red & Grey */
            --primary-red: #B71C1C;
            --light-red: #FFEBEE;
            --dark-grey: #424242;
            --light-grey: #f5f5f5;
            --border-color: #e0e0e0;
        }

        body { font-family: 'Roboto', sans-serif; background: var(--light-grey); padding: 0; margin: 0; color: var(--dark-grey); }
        
        /* LOGIN SCREEN */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--primary-red);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999;
        }
        .login-box {
            background: white; padding: 40px 30px; border-radius: 12px;
            width: 85%; max-width: 320px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .login-input {
            width: 100%; padding: 12px; margin-bottom: 15px;
            border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;
            font-size: 16px; text-align: center;
        }
        .btn-login {
            background: var(--dark-grey); color: white; border: none;
            padding: 12px; width: 100%; border-radius: 6px;
            font-size: 16px; font-weight: bold; cursor: pointer;
        }

        /* DASHBOARD */
        .container { 
            max-width: 600px; margin: 20px auto; background: white; 
            padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            display: none; 
        }
        
        .header { 
            display: flex; flex-direction: column; align-items: center; 
            margin-bottom: 20px; border-bottom: 1px solid var(--border-color); 
            padding-bottom: 20px; 
        }
        
        .logo-img { height: 50px; margin-bottom: 10px; }
        .portal-title { font-size: 18px; font-weight: 700; color: var(--dark-grey); text-transform: uppercase; }

        /* UPI SELECTOR */
        .upi-selector-box {
            width: 100%; background: var(--light-red); padding: 10px;
            border-radius: 8px; margin-bottom: 15px; text-align: center; border: 1px solid #ffcdd2;
            box-sizing: border-box;
        }
        .upi-label { font-size: 12px; font-weight: bold; color: var(--primary-red); display: block; margin-bottom: 5px; }
        .upi-dropdown { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; }

        /* CLIENT LIST */
        .client-card {
            border-bottom: 1px solid var(--border-color);
            padding: 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .client-info h3 { margin: 0 0 5px 0; font-size: 16px; color: #000; }
        .client-info p { margin: 0; font-size: 12px; color: #666; }
        
        .amount-badge {
            background-color: var(--primary-red); color: white;
            padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;
            display: inline-block; margin-top: 5px;
        }

        .actions { display: flex; gap: 8px; flex-direction: column; align-items: flex-end; }
        
        .btn { 
            padding: 8px 15px; border-radius: 6px; text-decoration: none; 
            font-size: 13px; font-weight: 500; display: flex; align-items: center; 
            justify-content: center; gap: 6px; border: none; cursor: pointer; width: 110px;
        }
        .btn-wa { background: #25D366; color: white; }
        .btn-qr { background: var(--light-grey); color: var(--dark-grey); border: 1px solid #ccc; }
        
        .qr-box { display: none; margin-top: 10px; padding: 10px; background: #fff; border: 1px solid #ccc; border-radius: 8px; text-align: center; }

        /* TOP CONTROLS */
        .top-controls { width: 100%; display: flex; justify-content: flex-end; gap: 15px; margin-bottom: 10px; }
        .icon-btn { cursor: pointer; color: #757575; font-size: 18px; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <img src="logocmte.png" alt="Logo" style="height: 40px; margin-bottom: 15px;" onerror="this.style.display='none'">
            <h2 style="color:var(--dark-grey); margin-top:0; font-size: 20px;">Secure Login</h2>
            
            <input type="email" id="adminEmail" class="login-input" placeholder="Email ID" value="shanicm@gmail.com">
            <input type="password" id="adminPin" class="login-input" placeholder="PIN Code" maxlength="4">
            
            <button class="btn-login" onclick="checkLogin()">ACCESS PORTAL</button>
            <p id="loginError" style="color:var(--primary-red); font-size:12px; margin-top:10px; display:none;">Access Denied.</p>
        </div>
    </div>

    <div class="container" id="mainDashboard">
        
        <div class="top-controls">
            <i class="fa-solid fa-rotate icon-btn" onclick="location.reload()" title="Refresh"></i>
            <i class="fa-solid fa-power-off icon-btn" style="color:var(--primary-red);" onclick="logout()" title="Logout"></i>
        </div>

        <div class="header">
            <img src="logocmte.png" alt="CM Tax Experts" class="logo-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
            <div class="portal-title">CM Tax Experts Payment Portal</div>
        </div>

        <div class="upi-selector-box">
            <label class="upi-label">SELECT RECEIVING ACCOUNT (UPI)</label>
            <select id="adminUpiSelect" class="upi-dropdown" onchange="updateLinks()">
                <option value="cmexperts@upi">Primary (cmexperts@upi)</option>
                <option value="shanicm@okaxis">Personal (shanicm@okaxis)</option>
                <option value="cmtax@hdfc">HDFC Bank (cmtax@hdfc)</option>
            </select>
        </div>

        <div id="loading" style="text-align:center; padding:40px; color:#666;">
            <i class="fa-solid fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px; color: var(--primary-red);"></i><br>
            Loading Clients...
        </div>

        <div id="clientList"></div>
    </div>

    <script>
        const CORRECT_PIN = "3655";
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyiBS9Xy9t3qvTKSipXRXLRJBmQJ9SeTEGZiyBh21eDRgiDobRvsVXGb1f7At6QuHv1/exec'; 
        let globalClientData = [];

        // LOGIN
        function checkLogin() {
            if (document.getElementById('adminPin').value === CORRECT_PIN) {
                localStorage.setItem('cmAdminLogin', 'true');
                showDashboard();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function showDashboard() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainDashboard').style.display = 'block';
            fetchData();
        }

        function logout() {
            localStorage.removeItem('cmAdminLogin');
            location.reload();
        }

        window.onload = function() {
            if (localStorage.getItem('cmAdminLogin') === 'true') showDashboard();
        };

        // FETCH DATA
        function fetchData() {
            fetch(WEB_APP_URL)
                .then(res => res.json())
                .then(data => {
                    document.getElementById('loading').style.display = 'none';
                    globalClientData = data;
                    renderList();
                })
                .catch(err => { document.getElementById('loading').innerHTML = 'Error loading data.'; });
        }

        // RENDER LIST
        function renderList() {
            const listContainer = document.getElementById('clientList');
            const selectedUPI = document.getElementById('adminUpiSelect').value;
            listContainer.innerHTML = '';
            
            if (globalClientData.length === 0) {
                listContainer.innerHTML = '<div style="text-align:center; padding:20px;">No pending payments.</div>';
                return;
            }

            globalClientData.forEach((row) => {
                // AUTO ADD '91' Logic
                let rawPhone = row.phone ? row.phone.toString().replace(/[^0-9]/g, '') : '';
                let phone = rawPhone;
                if (rawPhone.length === 10) {
                    phone = '91' + rawPhone; // Automatically adds 91 if missing
                }

                const payLink = `https://cmeg.in/pay.html?client=${encodeURIComponent(row.client)}&amt=${row.amount}&upi=${encodeURIComponent(selectedUPI)}`;
                
                // BOLD Message Text
                const msg = `*Payment Due*\n\nHello *${row.client}*,\n\nYour invoice amount of *₹${row.amount}* is pending.\n\nPlease scan the QR code or pay securely using this link:\n${payLink}`;
                const waLink = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
                const upiString = `upi://pay?pa=${selectedUPI}&pn=CMTaxExperts&am=${row.amount}&tn=Bill-${row.client}`;

                const card = document.createElement('div');
                card.className = 'client-card';
                card.innerHTML = `
                    <div class="client-info">
                        <h3>${row.client}</h3>
                        <div class="amount-badge">₹ ${row.amount}</div>
                        <p style="margin-top:5px; font-family:monospace;">${phone || 'No Mobile'}</p>
                    </div>
                    <div class="actions">
                        <a href="${waLink}" target="_blank" class="btn btn-wa"><i class="fa-brands fa-whatsapp"></i> Send Bill</a>
                        <button class="btn btn-qr" onclick="toggleQR(this, '${upiString}')"><i class="fa-solid fa-qrcode"></i> Show QR</button>
                        <div class="qr-box"></div>
                    </div>
                `;
                listContainer.appendChild(card);
            });
        }

        function updateLinks() { renderList(); }

        function toggleQR(btn, data) {
            const box = btn.nextElementSibling;
            if (box.style.display === 'block') {
                box.style.display = 'none';
                btn.innerHTML = '<i class="fa-solid fa-qrcode"></i> Show QR';
                btn.style.background = '#f5f5f5'; btn.style.color = '#333';
            } else {
                if (box.innerHTML === '') new QRCode(box, { text: data, width: 100, height: 100 });
                box.style.display = 'block';
                btn.innerText = 'Close QR';
                btn.style.background = '#333'; btn.style.color = '#fff';
            }
        }
    </script>

</body>
</html>
